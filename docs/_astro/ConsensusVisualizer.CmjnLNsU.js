import{j as r}from"./jsx-runtime.ClP7wGfN.js";import{r as d}from"./index.DK-fsZOb.js";import{A as D}from"./index.CMzh-1wI.js";import{m as G}from"./proxy.i6brGrIQ.js";const W={leader:"#10b981",candidate:"#f59e0b",follower:"#6b7280"},A={leader:"Leader",candidate:"Candidate",follower:"Follower"},F={election:"#f59e0b",vote:"#8b5cf6",heartbeat:"#0066cc",write:"#10b981",replicate:"#3b82f6",commit:"#10b981",failure:"#ef4444",info:"var(--sl-color-gray-3)"};function P(u=640){const[c,g]=d.useState(!1);return d.useEffect(()=>{const b=window.matchMedia(`(max-width: ${u}px)`);g(b.matches);const $=S=>g(S.matches);return b.addEventListener("change",$),()=>b.removeEventListener("change",$)},[u]),c}function I(){return Array.from({length:5},(u,c)=>({id:c,role:"follower",term:0,votedFor:null,log:[],alive:!0,voteGranted:!1}))}function Q(){const u=P(),[c,g]=d.useState(I),[b,$]=d.useState([{time:0,type:"info",message:"Cluster initialized with 5 follower nodes. Ready for leader election."}]),[S,N]=d.useState([]),[m,p]=d.useState(!1),[M,B]=d.useState(0),T=d.useRef(1),j=d.useRef(null),C=d.useRef(null),n=d.useCallback((e,i)=>{$(t=>[...t.slice(-49),{time:T.current++,type:e,message:i}])},[]);d.useEffect(()=>{C.current&&(C.current.scrollTop=C.current.scrollHeight)},[b]),d.useEffect(()=>{if(S.length===0){j.current&&cancelAnimationFrame(j.current);return}let e=performance.now();const i=t=>{const o=(t-e)/1e3;e=t,N(a=>a.map(h=>({...h,progress:h.progress+o*1.8})).filter(h=>h.progress<1)),j.current=requestAnimationFrame(i)};return j.current=requestAnimationFrame(i),()=>{j.current&&cancelAnimationFrame(j.current)}},[S.length>0]);const x=e=>new Promise(i=>setTimeout(i,e)),y=d.useCallback((e,i,t,o)=>{const a=`${e}-${i}-${Date.now()}-${Math.random()}`;N(l=>[...l,{id:a,from:e,to:i,label:t,color:o,progress:0}])},[]),w=d.useCallback(()=>{const e=c.find(i=>i.role==="leader"&&i.alive);return e?e.id:null},[c]),O=d.useCallback(async()=>{if(m)return;p(!0);const e=c.filter(s=>s.role==="follower"&&s.alive);if(e.length===0){n("info","No followers available to start an election."),p(!1);return}const i=w();if(i!==null){n("info",`Node ${i} is already the leader. Kill it first to trigger a new election.`),p(!1);return}const t=e[Math.floor(Math.random()*e.length)],o=t.term+1;n("election",`Node ${t.id} election timeout expired. Becoming candidate for term ${o}.`),g(s=>s.map(f=>f.id===t.id?{...f,role:"candidate",term:o,votedFor:t.id,voteGranted:!1}:f)),await x(500);const a=c.filter(s=>s.id!==t.id&&s.alive);n("vote",`Node ${t.id} sends RequestVote to ${a.length} nodes.`);for(const s of a)y(t.id,s.id,"RequestVote","#8b5cf6");await x(800);let l=1;const h=[t.id];for(const s of a)l++,h.push(s.id),y(s.id,t.id,"VoteGranted","#10b981"),g(f=>f.map(L=>L.id===s.id?{...L,term:o,votedFor:t.id,voteGranted:!0}:L));await x(800);const v=Math.floor(c.filter(s=>s.alive).length/2)+1;if(n("vote",`Node ${t.id} received ${l} votes (majority needs ${v}).`),l>=v){n("election",`Node ${t.id} wins election! Becomes leader for term ${o}.`),g(s=>s.map(f=>f.id===t.id?{...f,role:"leader",term:o}:f.alive?{...f,role:"follower",term:o,voteGranted:!1}:f)),await x(400),n("heartbeat",`Leader ${t.id} sends heartbeats to establish authority.`);for(const s of a)y(t.id,s.id,"Heartbeat","#0066cc")}else n("election",`Node ${t.id} failed to win election. Reverting to follower.`),g(s=>s.map(f=>f.id===t.id?{...f,role:"follower"}:f));await x(600),p(!1)},[m,c,n,y,w]),H=d.useCallback(async()=>{if(m)return;const e=w();if(e===null){n("info","No leader available. Start an election first.");return}p(!0);const i=`SET x=${M+1}`;B(l=>l+1),n("write",`Client sends write "${i}" to leader (Node ${e}).`),await x(400),g(l=>l.map(h=>h.id===e?{...h,log:[...h.log,i]}:h)),n("replicate",`Leader ${e} appends "${i}" to local log. Sending AppendEntries to followers.`),await x(300);const t=c.filter(l=>l.id!==e&&l.alive);for(const l of t)y(e,l.id,"AppendEntries","#3b82f6");await x(800);let o=1;for(const l of t)g(h=>h.map(v=>v.id===l.id?{...v,log:[...v.log,i]}:v)),y(l.id,e,"ACK","#10b981"),o++;await x(800);const a=Math.floor(c.filter(l=>l.alive).length/2)+1;o>=a?n("commit",`Entry "${i}" replicated to ${o}/${c.filter(l=>l.alive).length} nodes. Committed (majority=${a}).`):n("info",`Entry "${i}" only replicated to ${o} nodes. Not yet committed.`),await x(400),p(!1)},[m,c,w,n,y,M]),V=d.useCallback(async()=>{if(m)return;const e=w();if(e===null){n("info","No leader to kill.");return}p(!0),n("failure",`Node ${e} (Leader) has crashed! Cluster needs a new leader.`),g(i=>i.map(t=>t.id===e?{...t,alive:!1,role:"follower"}:t)),await x(500),n("info","Followers will detect missing heartbeats and start a new election."),p(!1)},[m,w,n]),q=d.useCallback(()=>{g(I()),$([{time:0,type:"info",message:"Cluster reset. 5 follower nodes ready."}]),N([]),p(!1),B(0),T.current=1},[]),z=(e,i)=>{const t=u?140:180,o=u?130:150,a=u?90:115,l=e*2*Math.PI/i-Math.PI/2;return{x:t+a*Math.cos(l),y:o+a*Math.sin(l)}},k=u?280:360,R=u?260:300,E=(e,i=!1)=>({padding:"0.4rem 0.9rem",borderRadius:"6px",border:"none",background:i?"var(--sl-color-gray-5)":e,color:"#fff",fontWeight:600,fontSize:"0.8rem",cursor:i?"not-allowed":"pointer",opacity:i?.5:1,transition:"opacity 0.15s",minHeight:36});return r.jsxs("div",{style:{border:"1px solid var(--sl-color-gray-5)",borderRadius:"0.75rem",overflow:"hidden",margin:"1.5rem 0"},children:[r.jsxs("div",{style:{padding:"1rem 1.25rem",borderBottom:"1px solid var(--sl-color-gray-5)",background:"var(--sl-color-gray-6)"},children:[r.jsx("h3",{style:{margin:0,fontSize:"1.1rem",fontWeight:700},children:"Raft Consensus Visualizer"}),r.jsx("p",{style:{margin:"0.25rem 0 0",fontSize:"0.8rem",color:"var(--sl-color-gray-3)"},children:"Simulate leader election, log replication, and heartbeats in a Raft cluster"})]}),r.jsxs("div",{style:{padding:"1.25rem"},children:[r.jsxs("div",{style:{display:"flex",gap:"0.5rem",flexWrap:"wrap",marginBottom:"1.25rem",alignItems:"center"},children:[r.jsx("button",{style:E("#f59e0b",m),onClick:O,disabled:m,children:"Start Election"}),r.jsx("button",{style:E("#0066cc",m),onClick:H,disabled:m,children:"Send Write"}),r.jsx("button",{style:E("#ef4444",m),onClick:V,disabled:m,children:"Kill Leader"}),r.jsx("button",{style:E("var(--sl-color-gray-4)",m),onClick:q,disabled:m,children:"Reset"})]}),r.jsxs("div",{style:{display:"flex",gap:"1rem",flexWrap:"wrap",marginBottom:"1rem"},children:[["leader","candidate","follower"].map(e=>r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.35rem",fontSize:"0.75rem"},children:[r.jsx("div",{style:{width:12,height:12,borderRadius:"50%",background:W[e]}}),r.jsx("span",{style:{fontWeight:600},children:A[e]})]},e)),r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.35rem",fontSize:"0.75rem"},children:[r.jsx("div",{style:{width:12,height:12,borderRadius:"50%",background:"#ef4444",opacity:.5}}),r.jsx("span",{style:{fontWeight:600},children:"Dead"})]})]}),r.jsx("div",{style:{display:"flex",justifyContent:"center",marginBottom:"1rem"},children:r.jsxs("svg",{width:k,height:R,viewBox:`0 0 ${k} ${R}`,children:[S.map(e=>{const i=z(e.from,5),t=z(e.to,5),o=i.x+(t.x-i.x)*e.progress,a=i.y+(t.y-i.y)*e.progress;return r.jsxs("g",{children:[r.jsx("line",{x1:i.x,y1:i.y,x2:t.x,y2:t.y,stroke:e.color,strokeWidth:1,strokeOpacity:.2,strokeDasharray:"4 4"}),r.jsx("circle",{cx:o,cy:a,r:5,fill:e.color,opacity:.9,children:r.jsx("animate",{attributeName:"r",values:"4;6;4",dur:"0.6s",repeatCount:"indefinite"})}),r.jsx("text",{x:o,y:a-10,textAnchor:"middle",fontSize:"8",fill:e.color,fontWeight:600,children:e.label})]},e.id)}),c.map((e,i)=>{const t=z(i,5),o=e.alive?W[e.role]:"#ef4444",a=u?26:32;return r.jsxs("g",{children:[e.role==="leader"&&e.alive&&r.jsxs("circle",{cx:t.x,cy:t.y,r:a+4,fill:"none",stroke:o,strokeWidth:2,opacity:.4,children:[r.jsx("animate",{attributeName:"r",values:`${a+2};${a+8};${a+2}`,dur:"2s",repeatCount:"indefinite"}),r.jsx("animate",{attributeName:"opacity",values:"0.4;0.1;0.4",dur:"2s",repeatCount:"indefinite"})]}),r.jsx("circle",{cx:t.x,cy:t.y,r:a,fill:e.alive?`${o}25`:`${o}15`,stroke:o,strokeWidth:e.role==="leader"?3:2,opacity:e.alive?1:.4}),r.jsxs("text",{x:t.x,y:t.y-6,textAnchor:"middle",fontSize:u?"11":"13",fontWeight:700,fill:e.alive?o:"#ef4444",children:["N",e.id]}),r.jsx("text",{x:t.x,y:t.y+8,textAnchor:"middle",fontSize:u?"8":"9",fill:e.alive?o:"#ef4444",children:e.alive?A[e.role]:"Dead"}),r.jsxs("text",{x:t.x,y:t.y+19,textAnchor:"middle",fontSize:"7",fill:"var(--sl-color-gray-3)",children:["T",e.term," | Log:",e.log.length]})]},e.id)}),r.jsxs("text",{x:k/2,y:R/2-6,textAnchor:"middle",fontSize:"11",fill:"var(--sl-color-gray-3)",fontWeight:600,children:["Term ",Math.max(...c.map(e=>e.term))]}),r.jsxs("text",{x:k/2,y:R/2+10,textAnchor:"middle",fontSize:"9",fill:"var(--sl-color-gray-4)",children:[c.filter(e=>e.alive).length,"/5 alive"]})]})}),r.jsx("div",{style:{display:"grid",gridTemplateColumns:u?"repeat(2, 1fr)":"repeat(5, 1fr)",gap:"0.5rem",marginBottom:"1.25rem"},children:c.map(e=>{const i=e.alive?W[e.role]:"#ef4444";return r.jsxs("div",{style:{padding:"0.5rem 0.6rem",borderRadius:"8px",border:`1.5px solid ${i}${e.alive?"":"66"}`,background:e.alive?`${i}12`:"transparent",opacity:e.alive?1:.5},children:[r.jsxs("div",{style:{fontSize:"0.75rem",fontWeight:700,color:i,marginBottom:"0.2rem"},children:["Node ",e.id]}),r.jsxs("div",{style:{fontSize:"0.65rem",color:"var(--sl-color-gray-3)",lineHeight:1.5},children:[r.jsxs("div",{children:["Role: ",e.alive?A[e.role]:"Dead"]}),r.jsxs("div",{children:["Term: ",e.term]}),r.jsxs("div",{children:["Log: [",e.log.slice(-2).join(", "),"]"]})]})]},e.id)})}),r.jsxs("div",{style:{marginBottom:"0.5rem"},children:[r.jsx("div",{style:{fontSize:"0.7rem",fontWeight:700,color:"var(--sl-color-gray-3)",textTransform:"uppercase",letterSpacing:"0.05em",marginBottom:"0.5rem"},children:"Event Log"}),r.jsx("div",{ref:C,style:{background:"var(--sl-color-gray-7, #0d1117)",border:"1px solid var(--sl-color-gray-5)",borderRadius:"8px",padding:"0.6rem 0.75rem",maxHeight:180,overflowY:"auto",fontFamily:"monospace",fontSize:"0.72rem",lineHeight:1.7},children:r.jsx(D,{children:b.map((e,i)=>r.jsxs(G.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},style:{color:F[e.type]},children:[r.jsxs("span",{style:{color:"var(--sl-color-gray-4)",marginRight:"0.5rem"},children:["[",String(e.time).padStart(3,"0"),"]"]}),r.jsx("span",{style:{display:"inline-block",padding:"0 0.3rem",borderRadius:"3px",background:`${F[e.type]}20`,fontSize:"0.65rem",fontWeight:600,marginRight:"0.4rem",textTransform:"uppercase"},children:e.type}),e.message]},`${e.time}-${i}`))})})]})]})]})}export{Q as default};
